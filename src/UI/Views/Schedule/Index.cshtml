@using Microsoft.Identity.Web
@using Domain.Common
@{
    Layout = "~/Views/Shared/_Schedule_Layout.cshtml";

    var unallocatedPanelId = Guid.NewGuid().ToString();
    var unallocatedSearchId = Guid.NewGuid().ToString();
    var unallocatedFilterId = Guid.NewGuid().ToString();
    var currentWeekId = Guid.NewGuid().ToString();
    var dayId = Guid.NewGuid().ToString();
    var dayButtonId = Guid.NewGuid().ToString();
    var dayDropdownId = Guid.NewGuid().ToString();
    var dayInputName = Guid.NewGuid().ToString();
    var dayTextId = Guid.NewGuid().ToString();

    var scheduleFormat = Html.Dispatcher().Query(new GetScheduleFormatQuery { FacultyId = Convert.ToInt32(Context.Request.Cookies[GlobalSelectors.FacultyId]) });

    var facultyId = (string)ViewData["FacultyId"];

    Action<IIncodingMetaLanguageCallbackBodyDsl> refreshWeek = dsl =>
    {
        dsl.WithId(GlobalSelectors.UnscheduledId).Trigger.None();
        dsl.WithId(GlobalSelectors.ScheduleId).Trigger.None();
    };
}

@section Body
{
    <div role="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <div class="d-flex gap-3">
        <div class="w-px-324 d-flex flex-column flex-shrink-0 gap-2">
            <div class="d-flex gap-2 flex-shrink-0 bg-base rounded">
                <a class="btn btn-primary p-1" href="@Url.Action("Index", "Home")">
                    <i class="material-symbols-rounded">home</i>
                </a>

                <a class="btn btn-light flex-grow-1" href="@Url.Action("Index", "Home")#@Url.Dispatcher().AsView("~/Views/Edit/Index.cshtml").ToRelative()">
                    @DataResources.EditingData
                </a>
            </div>
        </div>

        <div class="d-flex gap-3 flex-grow-1">
            <div class="d-flex gap-2 rounded flex-grow-1 bg-base">
                <div class="dropdown">
                    <button class="btn btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="False">
                        <span class="material-symbols-rounded">
                            content_copy
                        </span>
                        @DataResources.Copy
                    </button>
                    <div class="dropdown-menu" style="width: 250px;">
                        @using (Html.Controls().Form(control =>
                        {
                            control.Url = Url.Dispatcher().Push<CopyClassByWeekCommand>(new
                            {
                                DestinationWeek = Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week),
                                FacultyId = facultyId
                            });
                            control.Class = "px-3 py-1";
                            control.OnSave = dsl =>
                            {
                                refreshWeek(dsl);
                                dsl.WithSelf(s => s.Parent()).Trigger.Click();
                            };
                        }))
                        {
                            <div class="form-group mb-2">
                                <label>@DataResources.CopyFromWeek</label>
                                <input class="form-control" name="@nameof(CopyClassByWeekCommand.SourceWeek)" value="1"/>
                                @Html.ValidationMessage(nameof(CopyClassByWeekCommand.SourceWeek))
                            </div>
                            <div class="d-flex justify-content-end">
                                @(Html.When(JqueryBind.Click)
                                      .PreventDefault()
                                      .StopPropagation()
                                      .OnSuccess(dsl => dsl.WithSelf(s => s.Closest(HtmlTag.Form)).Trigger.Submit())
                                      .AsHtmlAttributes(classes: "btn btn-sm btn-primary")
                                      .ToButton(DataResources.Apply))
                            </div>
                        }
                    </div>
                </div>

                <div class="btn btn-light">
                    Экспорт
                </div>

                @Html.Controls().ButtonConfirm(settings =>
                {
                    settings.Text = DataResources.Clear;
                    settings.TextConfirm = DataResources.ConfirmClear;
                    settings.TextInProcess = DataResources.Clearing;
                    settings.Color = ConfirmSettings.ButtonColor.Light;
                    settings.Url = Url.Dispatcher().Push<DeleteClassesInWeekCommand>(new
                    {
                        SelectedGroupIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedGroupIds),
                        SelectedTeacherIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedTeacherIds),
                        SelectedAuditoriumIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedAuditoriumIds),
                        Week = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.Week),
                        FacultyId = Selector.Incoding.Cookie(GlobalSelectors.FacultyId)
                    });
                    settings.OnSuccess = dsl => refreshWeek(dsl);
                })
            </div>

            <div class="flex-shrink-0 d-flex gap-2 rounded bg-base">
                @(Html.When(JqueryBind.Change)
                      .StopPropagation()
                      .PreventDefault()
                      .Ajax(Url.Dispatcher().Push(new AddCookieCommand
                      {
                          Key = GlobalSelectors.FacultyId,
                          Value = Selector.Jquery.Self().Val()
                      }))
                      .AsHtmlAttributes(new { name = GlobalSelectors.FacultyId })
                      .ToInput(HtmlInputType.Hidden, facultyId))

                @(await Html.PartialAsync("~/Views/Shared/DropDown_Tmpl.cshtml", new DropdownModel
                {
                    Button = new DropdownModel.ButtonSettings
                    {
                        Text = DataResources.Faculty
                    },
                    Items = new List<IHtmlContent>
                    {
                        Html.Controls().Dropdown.List(settings =>
                        {
                            settings.Id = GlobalSelectors.FacultyListId;
                            settings.Url = Url.Dispatcher().Query<GetFacultiesQuery>(new { }).AsJson();
                            settings.CustomTemplate = "~/Views/Shared/DropDown/DropDownItem_Tmpl.cshtml";
                            settings.OnSuccess = dsl => Html.Controls().Dropdown.SetTitle(dsl, Selector.Jquery.EqualsAttribute("key", facultyId).Attr("code"));
                            settings.OnClick = dsl =>
                            {
                                Html.Controls().Dropdown.SetTitle(dsl, Selector.Event.Data.For("Code"));
                                dsl.WithName(GlobalSelectors.FacultyId).JQuery.Attr.Val(Selector.Event.Data.For("Id"));
                                dsl.WithName(GlobalSelectors.FacultyId).Trigger.Change();
                                dsl.Document.RedirectToSelf();
                            };
                        })
                    }
                }))

                <a class="btn btn-light p-1" href="@Url.Action("Index", "Home")#@Url.Dispatcher().AsView("~/Views/Settings/Index.cshtml").ToRelative()">
                    <i class="material-symbols-rounded">settings</i>
                </a>

                @await Html.PartialAsync("~/Views/Shared/DropDown_Tmpl.cshtml", new DropdownModel
                       {
                           Button = new DropdownModel.ButtonSettings
                           {
                               Text = User.GetDisplayName()
                           },
                           Items = new List<IHtmlContent>
                           {
                               Html.Controls().Dropdown.Href(Url.Action("SignOut", "Account", new { Area = "MicrosoftIdentity" }), DataResources.SignOut)
                           }
                       })
            </div>
        </div>
    </div>

    <div class="d-flex flex-grow-1 gap-3">
    <div class="mw-px-324 w-100 d-flex flex-column flex-shrink-0 gap-2 w-animate" id="@unallocatedPanelId">
        <div class="rounded bg-base flex-grow-1 p-2 d-flex flex-column gap-2">
            <div class="mb-1 d-flex gap-2">
                <div class="flex-grow-1 input" id="@unallocatedSearchId">
                    @(Html.When(JqueryBind.KeyUp)
                          .OnSuccess(dsl => dsl.Self().JQuery.Call("search", Selector.Jquery.Name("list").ToSelector()))
                          .AsHtmlAttributes(classes: "rounded search w-100 h-100")
                          .ToInput(HtmlInputType.Text, string.Empty))
                    <span class="material-symbols-rounded addon-r">search</span>
                </div>

                <div class="btn btn-light flex-shrink-0 p-1" id="@unallocatedFilterId">
                    <span class="material-symbols-rounded">filter_alt</span>
                </div>

                @(Html.When(JqueryBind.Click)
                      .OnSuccess(dsl =>
                      {
                          dsl.WithId(unallocatedPanelId).JQuery.Attr.ToggleClass("mw-px-324 mw-px-48");

                          dsl.Self().Insert.Use(@<span class="material-symbols-rounded">chevron_left</span>).Html()
                             .If(() => Selector.Jquery.Id(unallocatedPanelId).HasClass("mw-px-324"));
                          dsl.Self().Insert.Use(@<span class="material-symbols-rounded">chevron_right</span>).Html()
                             .If(() => Selector.Jquery.Id(unallocatedPanelId).HasClass("mw-px-48"));

                          dsl.WithId(unallocatedSearchId).JQuery.Attr.ToggleClass("hidden");
                          dsl.WithId(unallocatedFilterId).JQuery.Attr.ToggleClass("hidden");
                          dsl.WithId(GlobalSelectors.UnscheduledId).JQuery.Attr.ToggleClass("hidden");
                      })
                      .AsHtmlAttributes(classes: "btn btn-light flex-shrink-0 p-1")
                      .ToButton(@<span class="material-symbols-rounded">chevron_left</span>))
            </div>

            <div class="d-flex flex-column flex-grow-1 overflow-hidden flex-basis-0 position-relative">
                @(Html.When(JqueryBind.None)
                      .Ajax<GetClassByWeekQuery>(new
                      {
                          Week = Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week),
                          SelectedGroupIds = Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedGroupIds),
                          SelectedTeacherIds = Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedTeacherIds),
                          SelectedAuditoriumIds = Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedAuditoriumIds)
                      })
                      .OnBegin(dsl => dsl.Break.If(() => Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedGroupIds) == string.Empty
                                                         && Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedTeacherIds) == string.Empty
                                                         && Selector.Jquery.Name<GetClassByWeekQuery>(r => r.SelectedAuditoriumIds) == string.Empty))
                      .OnSuccess(dsl =>
                      {
                          dsl.Self().Insert.WithTemplateByView("~/Views/Schedule/Tmpl/Class_Tmpl.cshtml").Html();
                          dsl.Self().Insert.WithTemplateByUrl(Url.Dispatcher().Model<string>(DataResources.AllClassesScheduled).AsView("~/Views/Shared/Placeholder_Select.cshtml")).Html()
                             .If(() => Selector.Jquery.Self().Children().Length() == 0);
                      })
                      .OnComplete(dsl => dsl.Self().JQuery.PlugIn("dragAndDrop", new
                      {
                          item = Selector.Jquery.Role("drag-element").ToSelector(),
                          container = Selector.Jquery.Role("drag-container").ToSelector(),
                          forOne = true,
                          listContainer = Selector.Jquery.Name("list").ToSelector()
                      }))
                      .When("incodingdropped")
                      .AjaxPost(Url.Dispatcher().Push<DeleteClassCommand>(new { Id = Selector.Jquery.Self().Find(r => r.Name("card")).Find(r => r.Name<Class>(q => q.Id)) }))
                      .OnSuccess(dsl => dsl.Self().Trigger.None())
                      .AsHtmlAttributes(new
                      {
                          @class = "d-flex flex-column flex-grow-1 overflow-auto flex-basis-0",
                          id = GlobalSelectors.UnscheduledId,
                          role = "drag-container",
                          name = "list"
                      })
                      .ToDiv(@<text>
                                 @await Html.PartialAsync("~/Views/Shared/Placeholder_Select.cshtml", DataResources.Unavailable)
                              </text>))
            </div>
        </div>
    </div>

    <div class="d-flex flex-column flex-grow-1 gap-3">
        <div class="d-flex">
            <div class="d-flex gap-2 bg-base rounded">
                @Html.Controls().Select(settings =>
                {
                    settings.Name = nameof(GetScheduleByWeekQuery.SelectedTeacherIds);
                    settings.IsSearchable = true;
                    settings.IsMultiselect = true;
                    settings.Items = Html.Dispatcher().Query(new GetTeachersForSelectQuery { FacultyId = int.Parse(facultyId) });
                    settings.OnChange = dsl =>
                    {
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedGroupIds).JQuery.Call("selectpicker", "deselectAll");
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedAuditoriumIds).JQuery.Call("selectpicker", "deselectAll");

                        dsl.WithId(dayId).JQuery.Attr.AddClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() <= 2);
                        dsl.WithId(dayId).JQuery.Attr.RemoveClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() > 2);

                        refreshWeek(dsl);
                    };
                })

                @Html.Controls().Select(settings =>
                {
                    settings.Name = nameof(GetScheduleByWeekQuery.SelectedAuditoriumIds);
                    settings.IsSearchable = true;
                    settings.IsMultiselect = true;
                    settings.Items = Html.Dispatcher().Query(new GetAuditoriumsForDDQuery()).Select(s => (DropDownItem)s);
                    settings.OnChange = dsl =>
                    {
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedTeacherIds).JQuery.Call("selectpicker", "deselectAll");
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedGroupIds).JQuery.Call("selectpicker", "deselectAll");

                        dsl.WithId(dayId).JQuery.Attr.AddClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() <= 2);
                        dsl.WithId(dayId).JQuery.Attr.RemoveClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() > 2);

                        refreshWeek(dsl);
                    };
                })

                @Html.Controls().Select(settings =>
                {
                    settings.Name = nameof(GetScheduleByWeekQuery.SelectedGroupIds);
                    settings.IsSearchable = true;
                    settings.IsMultiselect = true;
                    settings.Items = Html.Dispatcher().Query(new GetGroupsForSelectQuery { FacultyId = int.Parse(facultyId) });
                    settings.OnChange = dsl =>
                    {
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedAuditoriumIds).JQuery.Call("selectpicker", "deselectAll");
                        //dsl.WithName<GetScheduleByWeekQuery>(r => r.SelectedTeacherIds).JQuery.Call("selectpicker", "deselectAll");

                        dsl.WithId(dayId).JQuery.Attr.AddClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() <= 2);
                        dsl.WithId(dayId).JQuery.Attr.RemoveClass("hidden")
                           .If(() => Selector.Jquery.Self().Closest(HtmlTag.Div).Find(r => r.Class("selected")).Length() > 2);

                        refreshWeek(dsl);
                    };
                })
            </div>

            <div class="ms-auto d-flex gap-3">
                @Html.Hidden(dayInputName, 1)
                @await Html.PartialAsync("~/Views/Shared/DropDown_Tmpl.cshtml", new DropdownModel
                       {
                           Button = new DropdownModel.ButtonSettings
                           {
                               Text = DataResources.Monday,
                               TextId = dayTextId,
                               Id = dayButtonId
                           },
                           Items = new List<IHtmlContent>
                           {
                               Html.Controls().Dropdown.List(settings =>
                               {
                                   settings.Id = dayDropdownId;
                                   settings.Url = Url.Dispatcher().Query<GetDaysOfWeekForDDQuery>(new
                                   {
                                       Week = Selector.Jquery.Name<GetDaysOfWeekForDDQuery>(r => r.Week)
                                   }).AsJson();
                                   settings.OnClick = dsl =>
                                   {
                                       dsl.WithName(dayInputName).JQuery.Attr.Val(Selector.Event.Data.For("value"));
                                       dsl.WithId(dayTextId).Insert.Use(Selector.Event.Data.For("text")).Html();

                                       refreshWeek(dsl);
                                   };
                               })
                           },
                           Id = dayId,
                           Classes = "hidden"
                       })

                <div class="d-flex gap-2 bg-base rounded">
                    @(Html.When(JqueryBind.Click)
                          .OnSuccess(dsl =>
                          {
                              dsl.WithName<GetClassByWeekQuery>(r => r.Week).Func.DecrementVal()
                                 .If(() => Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week) > 1);
                              dsl.WithId(currentWeekId).JQuery.Dom.Use(Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week)).Html();

                              refreshWeek(dsl);
                          })
                          .AsHtmlAttributes(classes: "btn btn-light p-1")
                          .ToButton(@<span class="material-symbols-rounded">arrow_back</span>))

                    @Html.Hidden(nameof(GetClassByWeekQuery.Week), 1)
                    <div class="btn btn-light" id="@currentWeekId">
                        1
                    </div>
                    @Html.Hidden(nameof(GetScheduleFormatQuery.Response.CountOfWeeks), scheduleFormat.CountOfWeeks)
                    @Html.Hidden(nameof(GetScheduleFormatQuery.Response.StartDate), scheduleFormat.StartDate)

                    @(Html.When(JqueryBind.Click)
                          .OnSuccess(dsl =>
                          {
                              dsl.WithName<GetClassByWeekQuery>(r => r.Week).Func.IncrementVal()
                                 .If(() => Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week) < Selector.Jquery.Name<AddOrEditScheduleFormatCommand>(r => r.CountOfWeeks));
                              dsl.WithId(currentWeekId).JQuery.Dom.Use(Selector.Jquery.Name<GetClassByWeekQuery>(r => r.Week)).Html();

                              refreshWeek(dsl);
                          })
                          .AsHtmlAttributes(classes: "btn btn-light p-1")
                          .ToButton(@<span class="material-symbols-rounded">arrow_forward</span>))
                </div>
            </div>
        </div>

        @(Html.When(JqueryBind.InitIncoding | JqueryBind.None)
              .Ajax(Url.Dispatcher().Query<GetScheduleByWeekQuery>(new
              {
                  SelectedGroupIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedGroupIds),
                  SelectedTeacherIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedTeacherIds),
                  SelectedAuditoriumIds = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedAuditoriumIds),
                  Week = Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.Week),
                  Day = Selector.Jquery.Name(dayInputName),
                  FacultyId = Selector.Incoding.Cookie(GlobalSelectors.FacultyId)
              }).AsJson())
              .OnBegin(dsl => dsl.Break.If(() => Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedGroupIds) == string.Empty
                                                 && Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedTeacherIds) == string.Empty
                                                 && Selector.Jquery.Name<GetScheduleByWeekQuery>(r => r.SelectedAuditoriumIds) == string.Empty))
              .OnSuccess(dsl => dsl.Self().Insert.WithTemplateByView("~/Views/Schedule/Tmpl/Schedule_Tmpl.cshtml").Html())
              .OnComplete(dsl => dsl.Self().JQuery.PlugIn("dragAndDrop", new
              {
                  item = Selector.Jquery.Role("drag-element").ToSelector(),
                  container = Selector.Jquery.Role("drag-container").ToSelector(),
                  forOne = true,
                  listContainer = Selector.Jquery.Name("list").ToSelector()
              }))
              .AsHtmlAttributes(classes: "flex-grow-1 d-flex flex-column gap-2 schedule rounded", id: GlobalSelectors.ScheduleId)
              .ToDiv(@<text>
                         @await Html.PartialAsync("~/Views/Shared/Placeholder_Select.cshtml", DataResources.ChooseSchedule)
                      </text>))
    </div>
    </div>
}
