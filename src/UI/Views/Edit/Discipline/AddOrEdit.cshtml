@using UI.Query
@using Domain.Common
@using Domain.App.Api
@using System.Reflection
@model AddOrEditDisciplineCommand
@{
    Layout = "~/Views/Shared/_AddOrEdit_Layout.cshtml";

    Action<IIncodingMetaLanguageCallbackBodyDsl> onChangeDisciplineType = dsl =>
    {
        dsl.With(s => s.EqualsAttribute("data-type", SubDisciplineKind.OfType.EXAM.ToString()))
           .JQuery.Attr.AddClass("d-none")
           .If(() => Selector.Jquery.Self() != 3);

        dsl.With(s => s.EqualsAttribute("data-type", SubDisciplineKind.OfType.EXAM.ToString()))
           .JQuery.Attr.RemoveClass("d-none")
           .If(() => Selector.Jquery.Self() == 3);
    };
}

@section Title
{
    @DataResources.Discipline
}

@section RemoveButton
{
    @Html.Controls().ButtonConfirm(settings =>
    {
        settings.IsDisabled = !Model.Id.HasValue;
        settings.Url = Url.Dispatcher().Push(new DeleteDisciplineCommand { Id = Model.Id ?? 0 });
        settings.OnSuccess = dsl => dsl.WithId(nameof(Discipline)).Trigger.Click();
        settings.Text = DataResources.Delete;
        settings.Icon = "delete";
        settings.TextConfirm = DataResources.ConfirmDelete;
        settings.TextInProcess = DataResources.Deletion;
        settings.Color = ConfirmSettings.ButtonColor.Danger;
    })
}

@section Body
{
    @using (Html.Controls().Form(settings =>
    {
        settings.Url = Url.Dispatcher().Push(new AddOrEditDisciplineCommand());
        settings.Class = "d-flex flex-column gap-3 p-1";
        settings.OnSave = dsl => dsl.WithId(nameof(Discipline)).Trigger.Click();
    }))
    {
        @Html.HiddenFor(s => s.Id)
        <div class="row">
            <div class="col-3">
                @Html.ForGroup(s => s.Name).TextBox(control =>
                {
                    control.Label.Name = DataResources.DisciplineName;
                    control.Input.OnChange = dsl => dsl.Self().Call("suggestInputValueByNamingCase", Selector.Jquery.Self(), nameof(Model.Code));
                })
            </div>
            <div class="col-2">
                @Html.ForGroup(s => s.Code).TextBox(control => control.Label.Name = DataResources.Abbreviation)
            </div>
            <div class="col-2">
                <div class="form-group">
                    @Html.LabelFor(s => s.DepartmentId, DataResources.Department)
                    @Html.Controls().Select(control =>
                    {
                        control.Class = "form-control";
                        control.Name = nameof(Model.DepartmentId);
                        control.Items = Html.Dispatcher().Query(new GetDepartmentsForDDQuery
                        {
                            SelectedId = Model.DepartmentId.GetValueOrDefault(),
                            FacultyId = Convert.ToInt32(Context.Request.Cookies[GlobalSelectors.FacultyId]),
                            Optional = "Без кафедры"
                        }).Select(s => (DropDownItem)s);
                        control.IsSearchable = true;
                    })
                    @Html.ValidationMessageFor(s => s.DepartmentId)
                </div>
            </div>
            <div class="col-2">
                <div class="form-group">
                    @Html.LabelFor(s => s.KindId, DataResources.DisciplineType)
                    @Html.Controls().Select(control =>
                    {
                        control.Class = "form-control";
                        control.Name = nameof(Model.KindId);
                        control.Items = Html.Dispatcher().Query(new GetDisciplineTypesForDDQuery
                        {
                            SelectedId = Model.KindId
                        }).Select(s => (DropDownItem)s);
                        control.OnChange = onChangeDisciplineType;
                        control.OnInit = onChangeDisciplineType;
                    })
                    @Html.ValidationMessageFor(s => s.KindId)
                </div>
            </div>
            <div class="col-3">
                <div class="form-group">
                    @Html.LabelFor(s => s.GroupIds, DataResources.GroupList)
                    @Html.Controls().Select(control =>
                    {
                        control.Class = "form-control";
                        control.Name = nameof(Model.GroupIds);
                        control.Items = Html.Dispatcher().Query(new GetGroupsForSelectQuery
                        {
                            SelectedIds = Model.GroupIds.ToArray(),
                            FacultyId = Convert.ToInt32(Context.Request.Cookies[GlobalSelectors.FacultyId]),
                        });
                        control.IsMultiselect = true;
                        control.IsSearchable = true;
                        control.ActionBox = true;
                        control.ChangeTimeout = 1000;
                        control.OnChange = dsl => dsl.WithName("plan-container").Trigger.None();
                    })
                    @Html.ValidationMessageFor(s => s.GroupIds)
                </div>
            </div>
        </div>
        <div class="form-divider"></div>
        <div class="row">
            <h5>@DataResources.SubDisciplines</h5>
            <div>
                <ul class="nav nav-tabs" role="tablist">
                    @{
                        var i = 0;
                    }
                    @foreach (var subDiscipline in Model.SubDisciplines)
                    {
                        <li class="nav-item" role="presentation" data-type="@subDiscipline.Type">
                            <button class="nav-link @(i == 0 ? "active" : "")" id="tab-@i" data-bs-toggle="tab" data-bs-target="#page-@i" type="button" role="tab" aria-controls="page-@i" aria-selected="@(i == 0 ? "true" : "false")">
                                @subDiscipline.Name
                            </button>
                        </li>
                        i++;
                    }
                </ul>
                <div class="tab-content">
                    @{
                        i = 0;
                    }
                    @foreach (var subDiscipline in Model.SubDisciplines)
                    {
                        <div class="tab-pane fade @(i == 0 ? "show active" : "")" id="page-@i" role="tabpanel" aria-labelledby="tab-@i" data-type="@subDiscipline.Type">
                            @Html.Hidden($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.Id)}", subDiscipline.Id)
                            @Html.Hidden($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.KindId)}", subDiscipline.KindId)
                            <div class="row mt-3">
                                <div class="form-group col-2">
                                    <label class="form-label">@DataResources.CountOfClass</label>
                                    @(Html.When(JqueryBind.Change)
                                          .OnSuccess(dsl => dsl.WithSelf(s => s.Closest(p => p.Class("tab-pane")).Find(c => c.Role("total"))).Insert.Use(Selector.Jquery.Self()).Text())
                                          .AsHtmlAttributes(new
                                          {
                                              @class = "form-control",
                                              name = $"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.Hours)}",
                                              placeholder = 0
                                          })
                                          .ToInput(HtmlInputType.Number, subDiscipline.Hours.ToString()))
                                    @Html.ValidationMessage($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.Hours)}")
                                </div>
                                @if (subDiscipline.Type != SubDisciplineKind.OfType.EXAM)
                                {
                                    <div class="form-group col-3">
                                        @Html.Label($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.IsParallelHours)}", DataResources.IsParallelType, new { @class = "form-label" })
                                        @Html.Controls().Select(control =>
                                        {
                                            control.Class = "form-control";
                                            control.Name = $"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.IsParallelHours)}";
                                            control.Items = Html.Dispatcher().Query(new GetSubDisciplineIsParallelOptionsForSelectQuery
                                            {
                                                Selected = subDiscipline.IsParallelHours
                                            });
                                            control.OnChange = dsl => dsl.WithSelf(s => s.Closest(p => p.Class("tab-pane")).Find(c => c.Name("plan-container")))
                                                                         .Trigger.None();
                                        })
                                    </div>
                                }
                                else
                                {
                                    @Html.Hidden($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.IsParallelHours)}", false)
                                }
                                <div class="form-group col-7">
                                    @Html.Label($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}", DataResources.Teachers, new { @class = "form-label" })
                                    @Html.Controls().Select(control =>
                                    {
                                        control.Name = $"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}";
                                        control.Class = "form-control";
                                        control.IsMultiselect = true;
                                        control.IsSearchable = true;
                                        control.Items = Html.Dispatcher().Query(new GetTeachersForSelectQuery
                                        {
                                            FacultyId = Convert.ToInt32(Context.Request.Cookies[GlobalSelectors.FacultyId]),
                                            SelectedIds = subDiscipline.TeacherIds
                                        });
                                        control.MaxVisibleElements = 1;
                                        control.ChangeTimeout = 1000;
                                        control.OnChange = dsl => dsl.WithSelf(s => s.Closest(p => p.Class("tab-pane")).Find(c => c.Name("plan-container")))
                                                                     .Trigger.None()
                                                                     .If(() => Selector.Jquery.Name($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}") != null);

                                        control.OnInit = dsl => dsl.WithSelf(s => s.Closest(p => p.Class("tab-pane")).Find(c => c.Name("plan-container")))
                                                                   .Trigger.None()
                                                                   .If(() => Selector.Jquery.Name($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}") != null ||
                                                                             Selector.Jquery.Name(nameof(Model.GroupIds)) != null);
                                    })
                                    @Html.ValidationMessage($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}")
                                </div>
                            </div>
                            <div class="row mt-3">
                                <h5>@DataResources.PreferencesToAuditorium</h5>
                                <div class="col form-group">
                                    @Html.Label($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumIds)}", DataResources.Auditorium, new { @class = "form-label" })
                                    @Html.Controls().Select(control =>
                                    {
                                        control.Name = $"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumIds)}";
                                        control.Class = "form-control";
                                        control.IsMultiselect = true;
                                        control.IsSearchable = true;
                                        control.MaxVisibleElements = 3;
                                        control.Items = Html.Dispatcher().Query(new GetAuditoriumsForSelectQuery
                                        {
                                            SelectedIds = subDiscipline.AuditoriumIds,
                                        });
                                        control.OnChange = dsl => dsl.WithName($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumKindIds)}")
                                                                     .JQuery.PlugIn("selectpicker", "deselectAll")
                                                                     .If(() => Selector.Jquery.Self() != null);
                                    })
                                    @Html.ValidationMessage($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumIds)}")
                                </div>
                                <div class="col form-group">
                                    @Html.Label($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumKindIds)}", DataResources.AuditoriumKind, new { @class = "form-label" })
                                    @Html.Controls().Select(control =>
                                    {
                                        control.Name = $"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumKindIds)}";
                                        control.Class = "form-control";
                                        control.IsMultiselect = true;
                                        control.IsSearchable = true;
                                        control.MaxVisibleElements = 3;
                                        control.Items = Html.Dispatcher().Query(new GetAuditoriumKindsForDDQuery
                                        {
                                            Ids = subDiscipline.AuditoriumKindIds.ToArray(),
                                        }).Select(s => (DropDownItem)s);
                                        control.OnChange = dsl => dsl.WithName($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumIds)}")
                                                                     .JQuery.PlugIn("selectpicker", "deselectAll")
                                                                     .If(() => Selector.Jquery.Self() != null);
                                    })
                                    @Html.ValidationMessage($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.AuditoriumKindIds)}")
                                </div>
                            </div>
                            @if (subDiscipline.Type != SubDisciplineKind.OfType.EXAM)
                            {
                                <div class="row mt-3">
                                    <h5>@DataResources.DisciplinePlanByWeeks</h5>
                                    @(Html.When(JqueryBind.None)
                                          .StopPropagation()
                                          .Ajax(Url.Dispatcher().Query<GetDisciplinePlansWEBQuery>(new
                                          {
                                              GroupIds = Selector.Jquery.Name<AddOrEditDisciplineCommand>(s => s.GroupIds),
                                              TeacherIds = Selector.Jquery.Name($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.TeacherIds)}"),
                                              LastIndex = i,
                                              SubDisciplineId = subDiscipline.Id,
                                              Hours = Selector.Jquery.Name($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.Hours)}"),
                                              IsParallelHours = Selector.Jquery.Name($"{nameof(Model.SubDisciplines)}[{i}].{nameof(subDiscipline.IsParallelHours)}")
                                          }).AsView("~/Views/Edit/Discipline/Tmpl/GroupsItem_Tmpl.cshtml"))
                                          .OnSuccess(dsl => dsl.Self().Insert.Html())
                                          .AsHtmlAttributes(new { name = "plan-container" })
                                          .ToDiv())
                                </div>
                            }
                        </div>
                        i++;
                    }
                </div>
            </div>

        </div>
    }
}
